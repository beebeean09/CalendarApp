<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Hello!</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  </head>
  <body ng-app='app' ng-controller='ctrl'>
    Hello this is the home page!
    <button ng-click="login()">Click here to see calendar!</button>
  </body>
  <script>
  let app = angular.module('app', []);

  app.controller('ctrl', function($scope, $http, $window, $location) {
    let newWindow;
    let url;

    $http.get('api/url').then(function(res) {
      console.log(res);
      url = res.data.URL;
    });

    $scope.login = function() {
      console.log(url);
      newWindow = $window.open(url, 'Please Log In With Google', 'width=700px, height=700px');
      // let landingUrl = "http://" + $window.location.host + "/url";
      // $window.location.href = landingUrl;
    };

    $window.onmessage = function(e) {
      // newWindow.close();
      let urlWithCode = e.data;
      let code = urlWithCode.split('code=')[1];
      code = code.replace('#', '');

      $http.get('tokens?code=' + code).then(function(res) {
        console.log('from window');
        console.log(res.data);
      })
      .then(function(res) {
        $window.location.href= '/tokens';
      })
    };


  });

  </script>
</html>
